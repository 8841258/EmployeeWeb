<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>comment.html</title>
	<script>
		window.onload = function () {
			loadCommentList();
		}

		//ajax, servlet 호출
		function loadCommentList() {
			let xhttp = new XMLHttpRequest();

			xhttp.open("get", "../CommentsServlet?cmd=selectAll");
			xhttp.send();

			xhttp.onreadystatechange = loadCommentResult;
		}

		function loadCommentResult() {
			if (this.readyState == 4 && this.status == 200) {
				let xmp = new DOMParser();
				let xmlDoc = xmp.parseFromString(this.responseText, 'text/xml');

				let code = xmlDoc.getElementsByTagName('code')[0].innerHTML;

				let listDiv = document.getElementById('commentList');

				if (code == 'success') {
					let commentList = eval(xmlDoc.getElementsByTagName('data')[0].innerHTML);
					console.log(commentList);

					for (let i = 0; i < commentList.length; i++) {
						let div = makeCommentView(commentList[i]);
						listDiv.appendChild(div);
					}
				}

				console.log(code);

			}
		}

		function makeCommentView(comment) {
			let div = document.createElement('div');
			div.setAttribute('id', comment.id);
			div.className = 'comment';
			div.comment = comment; //{id:1, name:'user', content:'test'}
			let str = '<strong>' + comment.name + '</strong>' + comment.content +
				'<input type="button" value="수정" onclick="viewUpdateForm('+comment.id+')">' +
				'<input type="button" value="삭제" onclick="confirmDeletion('+comment.id+')">';
			div.innerHTML = str;

			return div;
		}


		function addComment() {
			let name = addForm.name.value;
			if (name == "") {
				alert("이름을 입력하세요.");
				addForm.name.focus();
				return;
			}
			let content = addForm.content.value;
			if (content == "") {
				alert("내용을 입력하세요.");
				addForm.content.focus();
				return;
			}

			let xhttp = new XMLHttpRequest();

			let param = "&name=" + name + "&content=" + content;
			
			xhttp.open("get", "../CommentsServlet?cmd=insert" + param);
			xhttp.send();

			xhttp.onreadystatechange = addResult;
		}
		
		function addResult() {
			if (this.readyState == 4 && this.status == 200) {
				let xmp = new DOMParser();
				let xmlDoc = xmp.parseFromString(this.responseText, 'text/xml');
				console.log(xmlDoc);
				let code = xmlDoc.getElementsByTagName('code')[0].innerHTML;
				let listDiv = document.getElementById('commentList');
				if (code == "success") {
					// let comment = eval(xmlDoc.getElementsByTagName('data').item(0).innerHTML);
					let comment = JSON.parse(xmlDoc.getElementsByTagName('data').item(0).innerHTML);
					listDiv.appendChild(makeCommentView(comment));
					addForm.name.value = '';
					addForm.content.value = '';
					alert("등록되었습니다. [" + comment.id + "]");
				} else if (code == "error") {
					alert("에러가 발생했습니다.");
				}

			}
		}
		
		function viewUpdateForm(commentId) {
			let commentDiv = document.getElementById(commentId);
			let updateFormDiv = document.getElementById('commentUpdate');

			commentDiv.appendChild(updateFormDiv);
			let comment = commentDiv.comment; //id, name, content 정보를 부름.
			updateForm.id.value = comment.id;
			updateForm.name.value = comment.name;
			updateForm.content.value = comment.content;
			updateFormDiv.style.display = 'block';
		}
		
		function updateComment() {
			
		}

	</script>
</head>

<body>
	<div id="commentList"></div>
	<!-- 글 등록 -->
	<div id="commentAdd"></div>
	<form action="" name="addForm">
		이름 : <input type="text" name="name" size="10"><br>
		내용 : <textarea name="content" cols="20" rows="2"></textarea>
		<input type="button" value="등록" onclick="addComment()">
	</form>
	<!-- 글 수정 -->
	<div id="commentUpdate" style="display: none">
	<form action="" name="updateForm">
		이름 : <input type="text" name="name" size="10"><br>
		내용 : <textarea name="content" cols="20" rows="2"></textarea>
		<input type="button" value="변경" onclick="updateComment()">
		<input type="button" value="취소" onclick="cancelUpdate()">
	</form>
	</div>
</body>

</html>